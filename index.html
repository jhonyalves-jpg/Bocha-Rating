<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ratings da Bocha</title>

<style>
body { font-family: Arial, Helvetica, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
h1,h2 { text-align:center; }
table { width:100%; max-width:900px; margin:20px auto; border-collapse:collapse; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.1);}    
th,td { padding:8px; text-align:center; border-bottom:1px solid #ddd; }
th { background:#222; color:#fff; }
tr:nth-child(even){ background:#f2f2f2; }
.box { max-width:900px; margin:20px auto; background:#fff; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
input, select, button { padding:6px; margin:3px; }
button { cursor:pointer; }
.btn-del { background:#c0392b; color:#fff; border:none; padding:5px 8px; }

.admin-toggle {
  position:fixed;
  bottom:20px;
  right:20px;
  background:#222;
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:50px;
}
.admin-panel {
  display:none;
  max-width:900px;
  margin:30px auto;
  background:#fff;
  padding:15px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
  border:2px dashed #444;
}
</style>
</head>

<body>

<h1>ğŸ† Ranking de Ratings</h1>

<table>
<thead>
<tr>
  <th>#</th><th>Jogador</th><th>Rating</th><th>V</th><th>D</th>
</tr>
</thead>
<tbody id="ranking"></tbody>
</table>

<div class="box">
<h2>ğŸ“œ HistÃ³rico de Partidas</h2>
<table>
<thead><tr><th>A</th><th>Resultado</th><th>B</th></tr></thead>
<tbody id="historico"></tbody>
</table>
</div>

<!-- LOGIN -->
<div class="admin-panel" id="loginPanel">
  <h2>ğŸ” Login Admin</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginSenha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- ADMIN -->
<div class="admin-panel" id="adminPanel">
<h2>âš™ï¸ Painel Administrativo</h2>

<div class="box">
<input id="novoNome" placeholder="Nome">
<input id="novoRating" type="number" value="1500">
<input id="novoV" type="number" value="0">
<input id="novoD" type="number" value="0">
<button onclick="adicionarJogador()">Adicionar Jogador</button>
</div>

<div class="box">
<select id="jogadorA"></select>
<select id="resultado">
  <option value="1">VitÃ³ria A</option>
  <option value="0.5">Empate</option>
  <option value="0">Derrota A</option>
</select>
<select id="jogadorB"></select>
<button onclick="registrarPartida()">Salvar Partida</button>
</div>

<table>
<thead>
<tr><th>Jogador</th><th>Rating</th><th>V</th><th>D</th><th>AÃ§Ãµes</th></tr>
</thead>
<tbody id="adminTabela"></tbody>
</table>

<button onclick="logout()">ğŸšª Sair</button>
</div>

<button class="admin-toggle" onclick="toggleAdmin()">âš™ï¸</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCbiajdXpoQH72dLWv-qHmqx2-yYFggH4g",
  authDomain: "bocha-rating.firebaseapp.com",
  projectId: "bocha-rating",
  storageBucket: "bocha-rating.firebasestorage.app",
  messagingSenderId: "912115850854",
  appId: "1:912115850854:web:451f23ec2b47474a16d7a7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const K = 20;
let jogadores = [];
let historico = [];

const esperado = (ra,rb)=>1/(1+Math.pow(10,(rb-ra)/400));

async function carregar(){
  const snap = await getDoc(doc(db,"bocha","dados"));
  if(snap.exists()){
    jogadores = snap.data().jogadores || [];
    historico = snap.data().historico || [];
  }
  atualizarTudo();
}

async function salvar(){
  await setDoc(doc(db,"bocha","dados"),{ jogadores, historico });
}

function atualizarTudo(){
  atualizarRanking();
  atualizarAdmin();
  atualizarSelects();
  atualizarHistorico();
  salvar();
}

function atualizarRanking(){
  ranking.innerHTML='';
  jogadores.sort((a,b)=>b.rating-a.rating).forEach((j,i)=>{
    ranking.innerHTML+=`<tr><td>${i+1}</td><td>${j.nome}</td><td>${Math.round(j.rating)}</td><td>${j.v||0}</td><td>${j.d||0}</td></tr>`;
  });
}

function atualizarAdmin(){
  adminTabela.innerHTML='';
  jogadores.forEach((j,i)=>{
    adminTabela.innerHTML+=`
    <tr>
      <td>${j.nome}</td>
      <td><input value="${Math.round(j.rating)}" onchange="editarRating(${i},this.value)"></td>
      <td><input value="${j.v||0}" onchange="editarVD(${i},'v',this.value)"></td>
      <td><input value="${j.d||0}" onchange="editarVD(${i},'d',this.value)"></td>
      <td><button onclick="removerJogador(${i})">ğŸ—‘ï¸</button></td>
    </tr>`;
  });
}

function atualizarSelects(){
  jogadorA.innerHTML=jogadorB.innerHTML='';
  jogadores.forEach((j,i)=>{
    jogadorA.innerHTML+=`<option value="${i}">${j.nome}</option>`;
    jogadorB.innerHTML+=`<option value="${i}">${j.nome}</option>`;
  });
}

function atualizarHistorico(){
  historicoElem.innerHTML='';
  historico.forEach(p=>{
    historicoElem.innerHTML+=`<tr><td>${p.a}</td><td>${p.r}</td><td>${p.b}</td></tr>`;
  });
}

/* ===== AÃ‡Ã•ES ===== */
window.adicionarJogador=()=>{
  jogadores.push({nome:novoNome.value,rating:+novoRating.value,v:+novoV.value,d:+novoD.value});
  atualizarTudo();
};

window.registrarPartida=()=>{
  if(jogadorA.value===jogadorB.value) return alert("Jogadores iguais");

  const ia=+jogadorA.value, ib=+jogadorB.value;
  const sa=+resultado.value, sb=1-sa;

  const ra=jogadores[ia].rating, rb=jogadores[ib].rating;
  jogadores[ia].rating=ra+K*(sa-esperado(ra,rb));
  jogadores[ib].rating=rb+K*(sb-esperado(rb,ra));

  if(sa===1){jogadores[ia].v++;jogadores[ib].d++;}
  if(sa===0){jogadores[ib].v++;jogadores[ia].d++;}

  historico.unshift({a:jogadores[ia].nome,b:jogadores[ib].nome,r:sa==1?"1-0":sa==0.5?"Â½-Â½":"0-1"});
  atualizarTudo();
};

window.editarVD=(i,c,v)=>{jogadores[i][c]=+v||0;atualizarTudo();}
window.editarRating=(i,v)=>{jogadores[i].rating=+v||jogadores[i].rating;atualizarTudo();}
window.removerJogador=i=>{if(confirm("Remover?")){jogadores.splice(i,1);atualizarTudo();}}

window.login=async()=>{try{await signInWithEmailAndPassword(auth,loginEmail.value,loginSenha.value);}catch{alert("Login invÃ¡lido");}}
window.logout=()=>signOut(auth);
window.toggleAdmin=()=>{if(!auth.currentUser){loginPanel.style.display='block';return;}adminPanel.style.display=adminPanel.style.display==='block'?'none':'block';}

onAuthStateChanged(auth,u=>{loginPanel.style.display=u?'none':'block';adminPanel.style.display='none';});

const historicoElem=document.getElementById("historico");
carregar();
</script>

</body>
</html>
